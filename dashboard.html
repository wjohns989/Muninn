<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Huginn Control Center (Muninn Standalone)</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #111b2f;
      --panel-2: #0f1a2a;
      --text: #e8eef9;
      --muted: #9db0cf;
      --accent: #1f7a8c;
      --accent-2: #2aa88a;
      --ok: #2e9f5f;
      --warn: #c58a14;
      --err: #bd3f3f;
      --border: #22314b;
      --chip: #16253b;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 20px;
      background: radial-gradient(circle at top right, #12243f, var(--bg) 45%);
      color: var(--text);
      font-family: "Segoe UI", "Inter", sans-serif;
      line-height: 1.45;
    }

    .app {
      max-width: 1380px;
      margin: 0 auto;
      display: grid;
      gap: 14px;
    }

    .hero {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      background: linear-gradient(135deg, #142743, #0e1a2c 55%);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
    }

    .hero h1 {
      margin: 0;
      font-size: 1.3rem;
      letter-spacing: 0.3px;
    }

    .hero .sub {
      color: var(--muted);
      font-size: 0.95rem;
      margin-top: 4px;
    }

    .status-strip {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      background: var(--chip);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 12px;
      color: var(--muted);
      font-size: 0.82rem;
      white-space: nowrap;
    }

    .chip strong {
      color: var(--text);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 14px;
    }

    .panel {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      min-height: 120px;
    }

    .panel h2 {
      margin: 0 0 8px;
      font-size: 1rem;
      letter-spacing: 0.2px;
    }

    .panel .desc {
      margin: 0 0 12px;
      color: var(--muted);
      font-size: 0.88rem;
    }

    .col-4 {
      grid-column: span 4;
    }

    .col-6 {
      grid-column: span 6;
    }

    .col-8 {
      grid-column: span 8;
    }

    .col-12 {
      grid-column: span 12;
    }

    label {
      display: block;
      font-size: 0.82rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    .field-3 {
      grid-column: span 3;
    }

    .field-4 {
      grid-column: span 4;
    }

    .field-6 {
      grid-column: span 6;
    }

    .field-8 {
      grid-column: span 8;
    }

    .field-12 {
      grid-column: span 12;
    }

    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      background: #0a1425;
      color: var(--text);
      border: 1px solid #2b4062;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 0.88rem;
    }

    textarea {
      resize: vertical;
      min-height: 84px;
    }

    input[type="checkbox"] {
      accent-color: var(--accent-2);
      transform: scale(1.05);
    }

    .checkline {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 20px;
      color: var(--muted);
      font-size: 0.84rem;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    button {
      border: 1px solid transparent;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 0.84rem;
      cursor: pointer;
      color: #f5fbff;
      background: linear-gradient(135deg, var(--accent), #1a5775);
    }

    button.secondary {
      background: #12243c;
      border-color: #2a4162;
      color: var(--muted);
    }

    button.good {
      background: linear-gradient(135deg, #24815d, var(--ok));
    }

    button.warn {
      background: linear-gradient(135deg, #8d6110, var(--warn));
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .table-wrap {
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-top: 10px;
      max-height: 320px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
      min-width: 960px;
    }

    th,
    td {
      border-bottom: 1px solid #1f3150;
      padding: 8px;
      text-align: left;
      vertical-align: top;
    }

    th {
      position: sticky;
      top: 0;
      background: #162842;
      z-index: 2;
      color: #cbe2ff;
      font-weight: 600;
    }

    .code {
      font-family: Consolas, "Courier New", monospace;
      font-size: 0.78rem;
      word-break: break-all;
    }

    .badge {
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.72rem;
      background: #122a2b;
      color: #9de4d5;
    }

    .badge.off {
      background: #2d1c1c;
      color: #f2aeae;
    }

    .result {
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-top: 8px;
      padding: 10px;
      background: #0c1527;
      font-size: 0.82rem;
    }

    .result pre {
      margin: 8px 0 0;
      white-space: pre-wrap;
      font-size: 0.76rem;
      color: #c9dbf8;
    }

    .log {
      min-height: 110px;
      max-height: 240px;
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #081120;
      padding: 8px;
      font-family: Consolas, "Courier New", monospace;
      font-size: 0.76rem;
      color: #a8c4ed;
    }

    .log .ok {
      color: #6dd39b;
    }

    .log .warn {
      color: #e5c17a;
    }

    .log .err {
      color: #f08f8f;
    }

    @media (max-width: 1120px) {

      .col-4,
      .col-6,
      .col-8 {
        grid-column: span 12;
      }

      .field-3,
      .field-4,
      .field-6,
      .field-8 {
        grid-column: span 12;
      }

      table {
        min-width: 720px;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <section class="hero">
      <div>
        <h1>Huginn Browser Control Center</h1>
        <div class="sub">Standalone browser app for the Muninn memory engine. Use Muninn MCP mode when attached to an
          active assistant.</div>
      </div>
      <div class="status-strip">
        <div class="chip"><strong>Mode:</strong> <span id="chip-mode">Huginn (browser)</span></div>
        <div class="chip"><strong>Status:</strong> <span id="health-status">Checking...</span></div>
        <div class="chip"><strong>Auth:</strong> <span id="auth-status">Inactive</span></div>
      </div>
      <div class="chip"><strong>Backend:</strong> <span id="chip-backend">-</span></div>
      <div class="chip"><strong>Memories:</strong> <span id="chip-count">-</span></div>
      <div class="chip"><strong>Profile:</strong> <span id="chip-profile">balanced</span></div>
  </div>
  </section>

  <section class="grid">
    <div class="panel col-4">
      <h2>System</h2>
      <p class="desc">Health and quick controls.</p>
      <div class="row">
        <div class="field-12">
          <label for="server-auth-token">Server Auth Token</label>
          <input id="server-auth-token" type="password" placeholder="MUNINN_SERVER_AUTH_TOKEN" />
        </div>
      </div>
      <div class="btn-row">
        <button id="btn-apply-token" class="primary">Apply Token</button>
        <button id="btn-refresh-health" class="secondary">Refresh Health</button>
        <button id="btn-run-consolidation" class="warn">Run Consolidation</button>
      </div>
      <div class="result" id="system-result">No actions yet.</div>
    </div>

    <div class="panel col-8">
      <h2>Memory Search</h2>
      <p class="desc">Query memories with optional explain trace.</p>
      <div class="row">
        <div class="field-8">
          <label for="search-query">Query</label>
          <input id="search-query" type="text" placeholder="What did we decide about ingestion safety?" />
        </div>
        <div class="field-2">
          <label for="search-limit">Limit</label>
          <input id="search-limit" type="number" min="1" value="8" />
        </div>
        <div class="field-2 checkline">
          <input id="search-explain" type="checkbox" />
          <span>Explain trace</span>
        </div>
      </div>
      <div class="btn-row">
        <button id="btn-search">Search</button>
        <button id="btn-clear-search" class="secondary">Clear</button>
      </div>
      <div class="result" id="search-result">No searches yet.</div>
    </div>

    <div class="panel col-12">
      <h2>Project Folder Contextual Ingestion</h2>
      <p class="desc">Ingest local project paths. Use chronological ordering to preserve story flow in memory
        construction.</p>
      <div class="row">
        <div class="field-8">
          <label for="ingest-paths">Local paths (one per line)</label>
          <textarea id="ingest-paths"
            placeholder="C:\\Users\\user\\muninn_mcp\nC:\\Users\\user\\Documents\\project-notes"></textarea>
        </div>
        <div class="field-4">
          <label for="ingest-metadata">Extra metadata (JSON object)</label>
          <textarea id="ingest-metadata"
            placeholder='{"source":"browser_ui","context":"project_enrichment"}'></textarea>
        </div>
      </div>
      <div class="row">
        <div class="field-3">
          <label for="ingest-project">Project</label>
          <input id="ingest-project" type="text" value="global" />
        </div>
        <div class="field-3">
          <label for="ingest-namespace">Namespace</label>
          <input id="ingest-namespace" type="text" value="global" />
        </div>
        <div class="field-3">
          <label for="ingest-chronological">Chronological order</label>
          <select id="ingest-chronological">
            <option value="none">none (path order)</option>
            <option value="oldest_first">oldest_first</option>
            <option value="newest_first">newest_first</option>
          </select>
        </div>
        <div class="field-3 checkline">
          <input id="ingest-recursive" type="checkbox" checked />
          <span>Recursive</span>
        </div>
      </div>
      <div class="row">
        <div class="field-3">
          <label for="ingest-max-bytes">Max file bytes</label>
          <input id="ingest-max-bytes" type="number" min="1" value="5242880" />
        </div>
        <div class="field-3">
          <label for="ingest-chunk-size">Chunk size chars</label>
          <input id="ingest-chunk-size" type="number" min="1" value="1200" />
        </div>
        <div class="field-3">
          <label for="ingest-chunk-overlap">Chunk overlap chars</label>
          <input id="ingest-chunk-overlap" type="number" min="0" value="150" />
        </div>
        <div class="field-3">
          <label for="ingest-min-chunk">Min chunk chars</label>
          <input id="ingest-min-chunk" type="number" min="1" value="120" />
        </div>
      </div>
      <div class="btn-row">
        <button id="btn-ingest-project" class="good">Ingest Project Paths</button>
      </div>
      <div class="result" id="project-ingest-result">No project ingestion yet.</div>
    </div>

    <div class="panel col-12">
      <h2>Legacy Assistant and MCP Memory Reingestion</h2>
      <p class="desc">Discover local chat/memory artifacts, then select exactly what to reingest.</p>
      <div class="row">
        <div class="field-4">
          <label for="legacy-roots">Additional roots (one per line, optional)</label>
          <textarea id="legacy-roots" placeholder="C:\\Users\\user\\custom-chat-archives"></textarea>
        </div>
        <div class="field-4">
          <label for="legacy-providers">Provider filter (comma-separated, optional)</label>
          <textarea id="legacy-providers" placeholder="codex_cli, claude_code, serena_memory, cursor_chat"></textarea>
        </div>
        <div class="field-4">
          <label for="legacy-max-results">Max results per provider</label>
          <input id="legacy-max-results" type="number" min="1" value="120" />
          <div class="checkline">
            <input id="legacy-include-unsupported" type="checkbox" />
            <span>Include unsupported files in discovery list</span>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="field-3">
          <label for="legacy-project">Project</label>
          <input id="legacy-project" type="text" value="global" />
        </div>
        <div class="field-3">
          <label for="legacy-namespace">Namespace</label>
          <input id="legacy-namespace" type="text" value="global" />
        </div>
        <div class="field-3">
          <label for="legacy-chronological">Chronological order</label>
          <select id="legacy-chronological">
            <option value="none">none (path order)</option>
            <option value="oldest_first">oldest_first</option>
            <option value="newest_first">newest_first</option>
          </select>
        </div>
        <div class="field-3 checkline">
          <input id="legacy-recursive" type="checkbox" checked />
          <span>Recursive import</span>
        </div>
      </div>

      <div class="btn-row">
        <button id="btn-discover-legacy">Discover Sources</button>
        <button id="btn-auto-discover-import" class="good">Auto Discover + Import Supported</button>
        <button id="btn-select-supported" class="secondary">Select Parser-Supported</button>
        <button id="btn-clear-selection" class="secondary">Clear Selection</button>
        <button id="btn-import-legacy" class="good">Import Selected</button>
      </div>

      <div class="table-wrap">
        <table id="legacy-table">
          <thead>
            <tr>
              <th>Select</th>
              <th>Provider</th>
              <th>Supported</th>
              <th>Confidence</th>
              <th>Type</th>
              <th>Size</th>
              <th>Modified (UTC)</th>
              <th>Relative</th>
              <th>Path</th>
            </tr>
          </thead>
          <tbody id="legacy-table-body">
            <tr>
              <td colspan="9">No discovery run yet.</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="result" id="legacy-result">No legacy import actions yet.</div>
    </div>

    <div class="panel col-12">
      <h2>Operator Preferences</h2>
      <p class="desc">Persist browser-side defaults for ingestion workflows and model reasoning profile.</p>
      <div class="row">
        <div class="field-3">
          <label for="pref-model-profile">Model profile</label>
          <select id="pref-model-profile">
            <option value="low_latency">low_latency</option>
            <option value="balanced">balanced</option>
            <option value="high_reasoning">high_reasoning</option>
          </select>
        </div>
        <div class="field-3">
          <label for="pref-log-level">Log verbosity</label>
          <select id="pref-log-level">
            <option value="normal">normal</option>
            <option value="verbose">verbose</option>
          </select>
        </div>
        <div class="field-3 checkline">
          <input id="pref-auto-save" type="checkbox" checked />
          <span>Auto-save form preferences</span>
        </div>
        <div class="field-3">
          <label for="pref-version">Preference schema</label>
          <input id="pref-version" type="text" value="v1" readonly />
        </div>
      </div>
      <div class="btn-row">
        <button id="btn-save-preferences" class="secondary">Save Preferences</button>
        <button id="btn-reset-preferences" class="secondary">Reset Preferences</button>
      </div>
      <div class="result" id="preferences-result">Preferences not loaded yet.</div>
    </div>

    <div class="panel col-12">
      <h2>User Profile and Global Context</h2>
      <p class="desc">Editable user context that helps Huginn/Muninn prioritize relevant memories: skills, tool paths,
        environments, hardware, and workflow preferences.</p>
      <div class="row">
        <div class="field-12">
          <label for="user-profile-json">Profile JSON</label>
          <textarea id="user-profile-json"
            placeholder='{"preferences":{"coding_style":"roi-first"},"skills":["python","typescript"],"paths":{"workspace":"C:\\Users\\user\\muninn_mcp"},"hardware":{"gpu_vram_gb":16}}'></textarea>
        </div>
      </div>
      <div class="btn-row">
        <button id="btn-load-user-profile" class="secondary">Load Profile</button>
        <button id="btn-save-user-profile-merge">Save Profile (Merge)</button>
        <button id="btn-save-user-profile-replace" class="warn">Replace Profile</button>
      </div>
      <div class="result" id="user-profile-result">User profile not loaded yet.</div>
    </div>

    <div class="panel col-12">
      <h2>Federation & Sync</h2>
      <p class="desc">Generate synchronization manifests for cross-agent federation.</p>
      <div class="row">
        <div class="field-6">
          <label for="federation-project">Project Scope</label>
          <input id="federation-project" type="text" value="global" />
        </div>
      </div>
      <div class="btn-row">
        <button id="btn-gen-manifest" class="secondary">Generate Manifest</button>
      </div>
      <div class="result" id="federation-result">No manifest generated.</div>
    </div>

    <div class="panel col-12">
      <h2>Activity Log</h2>
      <p class="desc">Live browser action and API result trace.</p>
      <div class="log" id="activity-log"></div>
    </div>
  </section>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let legacyCatalog = [];
    const PREFS_KEY = "muninn-control-center-preferences-v1";
    const PREFS_VERSION = "v1";
    const PREF_FIELDS = {
      "pref-model-profile": { type: "value", default: "balanced" },
      "pref-log-level": { type: "value", default: "normal" },
      "pref-auto-save": { type: "checked", default: true },
      "search-limit": { type: "value", default: "8" },
      "search-explain": { type: "checked", default: false },
      "ingest-paths": { type: "value", default: "" },
      "ingest-metadata": { type: "value", default: "" },
      "ingest-project": { type: "value", default: "global" },
      "ingest-namespace": { type: "value", default: "global" },
      "ingest-chronological": { type: "value", default: "none" },
      "ingest-recursive": { type: "checked", default: true },
      "ingest-max-bytes": { type: "value", default: "5242880" },
      "ingest-chunk-size": { type: "value", default: "1200" },
      "ingest-chunk-overlap": { type: "value", default: "150" },
      "ingest-min-chunk": { type: "value", default: "120" },
      "legacy-roots": { type: "value", default: "" },
      "legacy-providers": { type: "value", default: "" },
      "legacy-max-results": { type: "value", default: "120" },
      "legacy-include-unsupported": { type: "checked", default: false },
      "legacy-project": { type: "value", default: "global" },
      "legacy-namespace": { type: "value", default: "global" },
      "legacy-chronological": { type: "value", default: "none" },
      "legacy-recursive": { type: "checked", default: true },
      "user-profile-json": { type: "value", default: "" },
      "server-auth-token": { type: "value", default: "" },
    };

    function nowStamp() {
      return new Date().toISOString().replace("T", " ").slice(0, 19);
    }

    function logLine(message, level = "ok") {
      const log = document.getElementById("activity-log");
      const div = document.createElement("div");
      div.className = level;
      div.textContent = `[${nowStamp()}] ${message}`;
      log.prepend(div);
    }

    function parseLines(text) {
      return text
        .split(/\r?\n/)
        .map((line) => line.trim())
        .filter((line) => line.length > 0);
    }

    function parseJsonOrEmpty(text) {
      if (!text || !text.trim()) return {};
      try {
        const parsed = JSON.parse(text);
        if (parsed && typeof parsed === "object" && !Array.isArray(parsed)) {
          return parsed;
        }
        throw new Error("Metadata must be a JSON object.");
      } catch (err) {
        throw new Error(`Invalid metadata JSON: ${err.message}`);
      }
    }

    function summarizeServerDetail(detail, statusCode = null) {
      const fallback = statusCode
        ? `Request failed (HTTP ${statusCode}). Check server logs for details.`
        : "Request failed. Check server logs for details.";
      if (detail === null || detail === undefined) return fallback;

      const raw = typeof detail === "string" ? detail : JSON.stringify(detail);
      if (!raw || raw === "{}") return fallback;

      const lowered = raw.toLowerCase();
      const sensitiveMarkers = [
        "traceback",
        "exception",
        "stack",
        "sql",
        "http://",
        "https://",
        "file \"",
      ];
      if (sensitiveMarkers.some((marker) => lowered.includes(marker))) {
        return fallback;
      }
      return raw.length > 220 ? `${raw.slice(0, 220)}...` : raw;
    }

    async function apiRequest(endpoint, payload = {}, method = "POST") {
      const url = `${API_BASE}${endpoint}`;
      const token = document.getElementById("server-auth-token").value.trim();

      const headers = {
        "Content-Type": "application/json",
      };

      if (token) {
        headers["Authorization"] = `Bearer ${token}`;
      }

      const options = {
        method,
        headers,
      };

      if (method !== "GET") {
        options.body = JSON.stringify(payload);
      }

      const response = await fetch(url, options);
      let data = {};
      try {
        data = await response.json();
      } catch (err) {
        data = {};
      }

      if (!response.ok) {
        if (response.status === 401) {
          updateAuthStatus("Unauthorized", "err");
        }
        throw new Error(summarizeServerDetail(data?.detail ?? data, response.status));
      }

      if (token) {
        updateAuthStatus("Authenticated", "ok");
      } else {
        updateAuthStatus("No Token", "warn");
      }

      return data.data ?? data;
    }

    function updateAuthStatus(text, level) {
      const el = document.getElementById("auth-status");
      if (!el) return;
      el.textContent = text;
      el.style.color = `var(--${level})`;
    }

    async function refreshHealth() {
      try {
        const health = await apiRequest("/health", null, "GET");
        document.getElementById("health-status").textContent = health.status || "unknown";
        document.getElementById("chip-backend").textContent = health.backend || "-";
        document.getElementById("chip-count").textContent = String(health.memory_count ?? "-");
        setResult("system-result", health);
        logLine("Health refreshed.");
      } catch (err) {
        document.getElementById("health-status").textContent = "error";
        setResult("system-result", { error: err.message });
        logLine(`Health check failed: ${err.message}`, "err");
      }
    }

    function setResult(elId, payload) {
      const el = document.getElementById(elId);
      if (!el) return;
      el.replaceChildren();
      const pre = document.createElement("pre");
      pre.textContent = JSON.stringify(payload, null, 2);
      el.appendChild(pre);
    }

    function getModelProfile() {
      return document.getElementById("pref-model-profile").value || "balanced";
    }

    function updateProfileChip() {
      document.getElementById("chip-profile").textContent = getModelProfile();
    }

    function collectPreferences() {
      const prefs = { version: PREFS_VERSION };
      Object.entries(PREF_FIELDS).forEach(([id, cfg]) => {
        const el = document.getElementById(id);
        if (!el) return;
        prefs[id] = cfg.type === "checked" ? !!el.checked : String(el.value ?? "");
      });
      return prefs;
    }

    function applyPreferences(prefs) {
      Object.entries(PREF_FIELDS).forEach(([id, cfg]) => {
        const el = document.getElementById(id);
        if (!el) return;
        const value = prefs && Object.prototype.hasOwnProperty.call(prefs, id)
          ? prefs[id]
          : cfg.default;
        if (cfg.type === "checked") {
          el.checked = Boolean(value);
        } else {
          el.value = String(value);
        }
      });
      document.getElementById("pref-version").value = PREFS_VERSION;
      updateProfileChip();
    }

    function loadPreferences() {
      try {
        const raw = window.localStorage.getItem(PREFS_KEY);
        if (!raw) {
          applyPreferences(null);
          setResult("preferences-result", { status: "defaults_loaded", version: PREFS_VERSION });
          return;
        }
        const parsed = JSON.parse(raw);
        applyPreferences(parsed);
        setResult("preferences-result", {
          status: "preferences_loaded",
          version: parsed.version || PREFS_VERSION,
        });
      } catch (err) {
        applyPreferences(null);
        setResult("preferences-result", {
          warning: "Preference payload was invalid. Defaults restored.",
          error: err.message,
        });
      }
    }

    function savePreferences(showResult = true) {
      const prefs = collectPreferences();
      window.localStorage.setItem(PREFS_KEY, JSON.stringify(prefs));
      updateProfileChip();
      if (showResult) {
        setResult("preferences-result", {
          status: "preferences_saved",
          version: prefs.version,
          profile: prefs["pref-model-profile"],
        });
      }
    }

    function resetPreferences() {
      window.localStorage.removeItem(PREFS_KEY);
      applyPreferences(null);
      setResult("preferences-result", { status: "preferences_reset", version: PREFS_VERSION });
      logLine("Preferences reset to defaults.", "warn");
    }

    async function refreshHealth() {
      try {
        const health = await apiRequest("/health", null, "GET");
        document.getElementById("chip-status").textContent = health.status || "unknown";
        document.getElementById("chip-backend").textContent = health.backend || "-";
        document.getElementById("chip-count").textContent = String(health.memory_count ?? "-");
        setResult("system-result", health);
        logLine("Health refreshed.");
      } catch (err) {
        document.getElementById("chip-status").textContent = "error";
        setResult("system-result", { error: err.message });
        logLine(`Health check failed: ${err.message}`, "err");
      }
    }

    async function runConsolidation() {
      try {
        const result = await apiRequest("/consolidation/run", {}, "POST");
        setResult("system-result", result);
        logLine("Consolidation triggered.", "warn");
      } catch (err) {
        setResult("system-result", { error: err.message });
        logLine(`Consolidation failed: ${err.message}`, "err");
      }
    }

    async function searchMemories() {
      const query = document.getElementById("search-query").value.trim();
      if (!query) {
        setResult("search-result", { warning: "Query is required." });
        return;
      }
      const limit = parseInt(document.getElementById("search-limit").value || "8", 10);
      const explain = document.getElementById("search-explain").checked;

      try {
        const result = await apiRequest("/search", {
          query,
          limit,
          rerank: true,
          explain,
          user_id: "global_user",
        });
        setResult("search-result", result);
        logLine(`Search completed with ${Array.isArray(result) ? result.length : 0} results.`);
      } catch (err) {
        setResult("search-result", { error: err.message });
        logLine(`Search failed: ${err.message}`, "err");
      }
    }

    async function ingestProjectPaths() {
      let metadata;
      try {
        metadata = parseJsonOrEmpty(document.getElementById("ingest-metadata").value);
      } catch (err) {
        setResult("project-ingest-result", { error: err.message });
        logLine(err.message, "err");
        return;
      }

      const sources = parseLines(document.getElementById("ingest-paths").value);
      if (!sources.length) {
        setResult("project-ingest-result", { warning: "At least one local path is required." });
        return;
      }

      const payload = {
        sources,
        user_id: "global_user",
        project: document.getElementById("ingest-project").value.trim() || "global",
        namespace: document.getElementById("ingest-namespace").value.trim() || "global",
        metadata: {
          ...metadata,
          source: metadata.source || "browser_ui_project_ingestion",
          contextual_project_ingestion: true,
          operator_model_profile: getModelProfile(),
        },
        recursive: document.getElementById("ingest-recursive").checked,
        chronological_order: document.getElementById("ingest-chronological").value,
        max_file_size_bytes: parseInt(document.getElementById("ingest-max-bytes").value || "5242880", 10),
        chunk_size_chars: parseInt(document.getElementById("ingest-chunk-size").value || "1200", 10),
        chunk_overlap_chars: parseInt(document.getElementById("ingest-chunk-overlap").value || "150", 10),
        min_chunk_chars: parseInt(document.getElementById("ingest-min-chunk").value || "120", 10),
      };

      try {
        const result = await apiRequest("/ingest", payload);
        setResult("project-ingest-result", result);
        logLine(`Project ingestion completed. Added ${result.added_memories || 0} memories.`);
        refreshHealth();
      } catch (err) {
        setResult("project-ingest-result", { error: err.message });
        logLine(`Project ingestion failed: ${err.message}`, "err");
      }
    }

    function selectedLegacySourceIds() {
      const ids = [];
      document.querySelectorAll("input[data-source-id]:checked").forEach((el) => ids.push(el.dataset.sourceId));
      return ids;
    }

    function renderLegacyTable() {
      const tbody = document.getElementById("legacy-table-body");
      tbody.replaceChildren();
      if (!legacyCatalog.length) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 9;
        cell.textContent = "No sources discovered.";
        row.appendChild(cell);
        tbody.appendChild(row);
        return;
      }

      legacyCatalog.forEach((source) => {
        const row = document.createElement("tr");

        const selectionCell = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.dataset.sourceId = String(source.source_id || "");
        checkbox.checked = Boolean(source.parser_supported);
        selectionCell.appendChild(checkbox);
        row.appendChild(selectionCell);

        const providerCell = document.createElement("td");
        providerCell.className = "code";
        providerCell.textContent = String(source.provider || "-");
        row.appendChild(providerCell);

        const supportCell = document.createElement("td");
        const supportBadge = document.createElement("span");
        supportBadge.className = source.parser_supported ? "badge" : "badge off";
        supportBadge.textContent = source.parser_supported ? "supported" : "unsupported";
        supportCell.appendChild(supportBadge);
        row.appendChild(supportCell);

        const confidenceCell = document.createElement("td");
        confidenceCell.textContent = String(source.confidence ?? "-");
        row.appendChild(confidenceCell);

        const typeCell = document.createElement("td");
        typeCell.textContent = String(source.source_type || "-");
        row.appendChild(typeCell);

        const sizeCell = document.createElement("td");
        sizeCell.textContent = String(source.size_bytes ?? "-");
        row.appendChild(sizeCell);

        const modifiedCell = document.createElement("td");
        modifiedCell.textContent = String(source.modified_at_iso || "-");
        row.appendChild(modifiedCell);

        const relativePathCell = document.createElement("td");
        relativePathCell.className = "code";
        relativePathCell.textContent = String(source.relative_path_hint || "-");
        row.appendChild(relativePathCell);

        const fullPathCell = document.createElement("td");
        fullPathCell.className = "code";
        fullPathCell.textContent = String(source.path || "-");
        row.appendChild(fullPathCell);

        tbody.appendChild(row);
      });
    }

    async function discoverLegacySources() {
      const roots = parseLines(document.getElementById("legacy-roots").value);
      const providerRaw = parseLines(document.getElementById("legacy-providers").value).join(",");
      const providers = providerRaw
        .split(",")
        .map((p) => p.trim())
        .filter(Boolean);

      const payload = {
        roots,
        providers,
        include_unsupported: document.getElementById("legacy-include-unsupported").checked,
        max_results_per_provider: parseInt(document.getElementById("legacy-max-results").value || "120", 10),
      };

      try {
        const result = await apiRequest("/ingest/legacy/discover", payload);
        legacyCatalog = result.sources || [];
        renderLegacyTable();
        setResult("legacy-result", {
          event: result.event,
          total_discovered: result.total_discovered,
          parser_supported: result.parser_supported,
          parser_unsupported: result.parser_unsupported,
          provider_counts: result.provider_counts,
        });
        logLine(`Legacy discovery completed. Found ${result.total_discovered || 0} sources.`);
        return result;
      } catch (err) {
        setResult("legacy-result", { error: err.message });
        logLine(`Legacy discovery failed: ${err.message}`, "err");
        return null;
      }
    }

    function selectParserSupported() {
      const parserSupportedSet = new Set(
        legacyCatalog.filter((item) => item.parser_supported).map((item) => item.source_id)
      );
      document.querySelectorAll("input[data-source-id]").forEach((el) => {
        el.checked = parserSupportedSet.has(el.dataset.sourceId);
      });
      logLine("Selected parser-supported legacy sources.");
    }

    function clearLegacySelection() {
      document.querySelectorAll("input[data-source-id]").forEach((el) => {
        el.checked = false;
      });
      logLine("Cleared legacy source selection.", "warn");
    }

    async function importSelectedLegacy() {
      const selectedSourceIds = selectedLegacySourceIds();
      if (!selectedSourceIds.length) {
        setResult("legacy-result", { warning: "Select at least one discovered source." });
        return null;
      }

      const roots = parseLines(document.getElementById("legacy-roots").value);
      const providerRaw = parseLines(document.getElementById("legacy-providers").value).join(",");
      const providers = providerRaw
        .split(",")
        .map((p) => p.trim())
        .filter(Boolean);

      const payload = {
        selected_source_ids: selectedSourceIds,
        roots,
        providers,
        include_unsupported: document.getElementById("legacy-include-unsupported").checked,
        max_results_per_provider: parseInt(document.getElementById("legacy-max-results").value || "120", 10),
        user_id: "global_user",
        project: document.getElementById("legacy-project").value.trim() || "global",
        namespace: document.getElementById("legacy-namespace").value.trim() || "global",
        recursive: document.getElementById("legacy-recursive").checked,
        chronological_order: document.getElementById("legacy-chronological").value,
        metadata: {
          source: "browser_ui_legacy_import",
          selected_source_count: selectedSourceIds.length,
          operator_model_profile: getModelProfile(),
        },
      };

      try {
        const result = await apiRequest("/ingest/legacy/import", payload);
        setResult("legacy-result", result);
        logLine(`Legacy import completed. Added ${result.added_memories || 0} memories.`);
        refreshHealth();
        return result;
      } catch (err) {
        setResult("legacy-result", { error: err.message });
        logLine(`Legacy import failed: ${err.message}`, "err");
        return null;
      }
    }

    async function autoDiscoverAndImportLegacy() {
      const priorOrder = document.getElementById("legacy-chronological").value;
      if (priorOrder === "none") {
        document.getElementById("legacy-chronological").value = "oldest_first";
        logLine("Auto mode set legacy chronological order to oldest_first for development-phase continuity.");
      }
      const discovery = await discoverLegacySources();
      if (!discovery) return;
      selectParserSupported();
      const selected = selectedLegacySourceIds();
      if (!selected.length) {
        setResult("legacy-result", { warning: "No parser-supported discovered sources available for import." });
        logLine("Auto import skipped because no parser-supported sources were discovered.", "warn");
        return;
      }
      await importSelectedLegacy();
    }

    async function loadUserProfile() {
      try {
        const result = await apiRequest("/profile/user/get", null, "GET");
        const profile = result.profile || {};
        document.getElementById("user-profile-json").value = JSON.stringify(profile, null, 2);
        setResult("user-profile-result", result);
        logLine(`Loaded user profile (${result.event}).`);
      } catch (err) {
        setResult("user-profile-result", { error: err.message });
        logLine(`Load user profile failed: ${err.message}`, "err");
      }
    }

    async function saveUserProfile(merge) {
      let profile;
      try {
        profile = parseJsonOrEmpty(document.getElementById("user-profile-json").value);
      } catch (err) {
        const message = "Invalid JSON format in user profile.";
        setResult("user-profile-result", { error: message });
        logLine(message, "err");
        return;
      }

      const payload = {
        user_id: "global_user",
        profile,
        merge: Boolean(merge),
        source: "browser_ui_user_profile",
      };

      try {
        const result = await apiRequest("/profile/user/set", payload);
        document.getElementById("user-profile-json").value = JSON.stringify(result.profile || {}, null, 2);
        setResult("user-profile-result", result);
        logLine(`Saved user profile with merge=${Boolean(merge)}.`);
      } catch (err) {
        setResult("user-profile-result", { error: err.message });
        logLine(`Save user profile failed: ${err.message}`, "err");
      }
    }

    function clearSearchResult() {
      document.getElementById("search-result").textContent = "Search results cleared.";
    }

    function bindPreferenceAutoSave() {
      Object.keys(PREF_FIELDS).forEach((id) => {
        if (id === "pref-auto-save") return;
        const el = document.getElementById(id);
        if (!el) return;
        const eventName = el.tagName === "INPUT" && el.type === "text" ? "input" : "change";
        el.addEventListener(eventName, () => {
          if (document.getElementById("pref-auto-save").checked) {
            savePreferences(false);
          }
          if (id === "pref-model-profile") {
            updateProfileChip();
          }
        });
      });
      document.getElementById("pref-auto-save").addEventListener("change", () => {
        savePreferences(true);
      });
    }

    document.getElementById("btn-apply-token").addEventListener("click", () => {
      savePreferences(true);
      refreshHealth();
      loadUserProfile();
      logLine("Security token applied.");
    });

    document.getElementById("btn-refresh-health").addEventListener("click", refreshHealth);
    document.getElementById("btn-run-consolidation").addEventListener("click", runConsolidation);
    document.getElementById("btn-search").addEventListener("click", searchMemories);
    document.getElementById("btn-clear-search").addEventListener("click", clearSearchResult);
    document.getElementById("btn-ingest-project").addEventListener("click", ingestProjectPaths);
    document.getElementById("btn-discover-legacy").addEventListener("click", discoverLegacySources);
    document.getElementById("btn-auto-discover-import").addEventListener("click", autoDiscoverAndImportLegacy);
    document.getElementById("btn-select-supported").addEventListener("click", selectParserSupported);
    document.getElementById("btn-clear-selection").addEventListener("click", clearLegacySelection);
    document.getElementById("btn-import-legacy").addEventListener("click", importSelectedLegacy);
    document.getElementById("btn-load-user-profile").addEventListener("click", loadUserProfile);
    document.getElementById("btn-save-user-profile-merge").addEventListener("click", () => saveUserProfile(true));
    document.getElementById("btn-save-user-profile-replace").addEventListener("click", () => saveUserProfile(false));
    document.getElementById("btn-save-preferences").addEventListener("click", () => {
      savePreferences(true);
      logLine("Preferences saved.");
    });
    document.getElementById("btn-reset-preferences").addEventListener("click", resetPreferences);

    // Federation Logic
    async function generateManifest() {
      const project = document.getElementById("federation-project").value.trim() || "global";
      try {
        const result = await apiRequest(`/federation/manifest?project=${encodeURIComponent(project)}`, {}, "POST");
        setResult("federation-result", result);
        logLine(`Manifest generated for project '${project}'.`);
      } catch (err) {
        setResult("federation-result", { error: err.message });
        logLine(`Manifest generation failed: ${err.message}`, "err");
      }
    }

    document.getElementById("btn-gen-manifest").addEventListener("click", generateManifest);

    document.getElementById("search-query").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        searchMemories();
      }
    });

    loadPreferences();
    bindPreferenceAutoSave();
    refreshHealth();
    loadUserProfile();
    logLine("Browser control center loaded.");
  </script>
</body>

</html>