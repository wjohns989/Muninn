============================= test session starts =============================
platform win32 -- Python 3.13.0, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\wjohn\miniconda3\python.exe
cachedir: .pytest_cache
SuperClaude: 4.1.9
rootdir: C:\Users\wjohn\muninn_mcp
configfile: pyproject.toml
plugins: anyio-4.12.1, langsmith-0.6.4, asyncio-1.3.0, hydra-core-1.3.2, cov-7.0.0, superclaude-4.1.9, typeguard-4.4.4
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

tests/test_v3_22_1_contradiction_detection.py::test_v3_22_1_contradiction_detection_prevents_merge FAILED [100%]

================================== FAILURES ===================================
_____________ test_v3_22_1_contradiction_detection_prevents_merge _____________

mock_daemon = <muninn.consolidation.daemon.ConsolidationDaemon object at 0x00000280026CF620>

    @pytest.mark.asyncio
    async def test_v3_22_1_contradiction_detection_prevents_merge(mock_daemon):
        now = time.time()
    
        # Create two contradictory memories
        older_memory = MemoryRecord(
            id="mem_old",
            content="The system architecture uses SQLite.",
            memory_type=MemoryType.EPISODIC,
            created_at=now - 1000,
            user_id="user_1",
            namespace="global",
            importance=0.8,
            vector_id="v_old",
            access_count=1,
        )
        newer_memory = MemoryRecord(
            id="mem_new",
            content="The system architecture uses Postgres.",
            memory_type=MemoryType.EPISODIC,
            created_at=now,
            user_id="user_1",
            namespace="global",
            importance=0.8,
            vector_id="v_new",
            access_count=1,
        )
    
        # Mock metadata store finding these for consolidation
        mock_daemon.metadata.get_for_consolidation.return_value = [older_memory, newer_memory]
    
        # Mock find_merge_candidates to return them as highly similar candidates
        with patch("muninn.consolidation.daemon.find_merge_candidates") as mock_find_candidates:
            # Return tuples of (primary_id, secondary_id, score)
            mock_find_candidates.return_value = [("mem_new", "mem_old", 0.95)]
    
            # Mock metadata.get to return the actual records
            def mock_get(mem_id):
                if mem_id == "mem_old": return older_memory
                if mem_id == "mem_new": return newer_memory
                return None
            mock_daemon.metadata.get.side_effect = mock_get
    
            # Mock the LLM synthesis to confirm the contradiction
            with patch("muninn.extraction.temporal_synthesis.synthesize_temporal_contradiction") as mock_synth:
                mock_synth.return_value = TemporalContradictionResolution(
                    contradiction_confirmed=True,
                    superseding_fact="The system architecture uses Postgres.",
                    outdated_fact="The system architecture uses SQLite.",
                    explanation="Postgres replaces SQLite over time."
                )
    
                result = await mock_daemon._phase_merge()
    
                # The MERGE phase should have aborted the standard merge
                assert result["merged"] == 0
    
                # Verify that the LLM was called
                mock_synth.assert_called_once()
    
                # Verify that the older memory (mem_old) was shadowed / archived
                # It should have updated metadata with superseded_by and importance drop
                # Use ANY for the metadata check to debug what actually got updated
>               mock_daemon.metadata.update_metadata.assert_called_with("mem_old", ANY)
                                                                                   ^^^
E               NameError: name 'ANY' is not defined

tests\test_v3_22_1_contradiction_detection.py:107: NameError
============================== warnings summary ===============================
..\AppData\Roaming\Python\Python313\site-packages\huggingface_hub\constants.py:244
  C:\Users\wjohn\AppData\Roaming\Python\Python313\site-packages\huggingface_hub\constants.py:244: DeprecationWarning: The `HF_HUB_ENABLE_HF_TRANSFER` environment variable is deprecated as 'hf_transfer' is not used anymore. Please use `HF_XET_HIGH_PERFORMANCE` instead to enable high performance transfer with Xet. Visit https://huggingface.co/docs/huggingface_hub/package_reference/environment_variables#hfxethighperformance for more details.
    warnings.warn(

tests/test_v3_22_1_contradiction_detection.py::test_v3_22_1_contradiction_detection_prevents_merge
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type SwigPyPacked has no __module__ attribute

tests/test_v3_22_1_contradiction_detection.py::test_v3_22_1_contradiction_detection_prevents_merge
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type SwigPyObject has no __module__ attribute

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_v3_22_1_contradiction_detection.py::test_v3_22_1_contradiction_detection_prevents_merge
======================= 1 failed, 3 warnings in 15.18s ========================
